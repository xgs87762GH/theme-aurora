<!doctype html>
<html
  xmlns:th="https://www.thymeleaf.org"
  th:replace="~{modules/layouts/layout :: html(title = |#{page.moments.title} - ${site.title}|, hero = null, content = ~{::content}, head = null, footer = null, sidebar = null, contentClass = null)}"
>
  <th:block th:fragment="content">
    <!-- 使用通用三栏布局 -->
    <th:block th:replace="~{modules/layouts/three-column-layout :: three-column-layout-auto(mainContent = ~{::main-content}, leftContent = null, rightContent = null)}" />
  </th:block>

  <th:block th:fragment="main-content">
    <div class="aurora-moments-container">
      <!-- 动态列表 -->
      <ul
        role="list"
        class="aurora-moments-list"
        x-data="upvote('moment','moment.halo.run','moments')"
      >
        <li
          th:each="moment : ${moments.items}"
          th:attr="x-data=|{name:'${moment.metadata.name}',showComment:false}|"
          th:with="content=${moment.spec.content}"
          class="aurora-moment-card"
        >
          <div class="aurora-moment-card-inner">
            <!-- 头像 -->
            <img
              th:src="${moment.owner.avatar ?: #theme.assets('/images/default-avatar.svg')}"
              th:title="${moment.owner.displayName}"
              th:alt="${moment.owner.displayName}"
              class="aurora-moment-avatar"
            />
            
            <!-- 内容区域 -->
            <div class="aurora-moment-content">
              <!-- 用户信息 -->
              <div class="aurora-moment-header">
                <span class="aurora-moment-author" th:text="${moment.owner.displayName}"></span>
                <span class="aurora-moment-time" th:text="${#dates.format(moment.spec.releaseTime,'yyyy-MM-dd HH:mm')}"></span>
              </div>
              
              <!-- 动态内容 -->
              <div
                th:utext="${content.html}"
                class="aurora-moment-text"
              ></div>
              
              <!-- 媒体内容 -->
              <div
                th:unless="${#lists.isEmpty(moment.spec.content.medium)}"
                class="aurora-moment-media"
                th:classappend="${moment.spec.content.medium.size() == 1 ? 'media-single' : (moment.spec.content.medium.size() == 2 ? 'media-double' : (moment.spec.content.medium.size() == 3 ? 'media-triple' : 'media-multiple'))}"
                th:attr="data-media-count=${moment.spec.content.medium.size()}"
              >
                <div class="aurora-moment-media-item" th:each="media : ${moment.spec.content.medium}">
                  <img
                    th:if="${#strings.equals(media.type,'PHOTO')}"
                    class="aurora-moment-image"
                    th:src="${media.url}"
                    th:srcset="|${thumbnail.gen(media.url, 's')} 400w,
                                ${thumbnail.gen(media.url, 'm')} 800w,
                                ${thumbnail.gen(media.url, 'l')} 1200w|"
                    sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 33vw"
                  />
                  <div
                    th:if="${#strings.equals(media.type,'VIDEO')}"
                    x-data="{openVideoModal:false}"
                    class="aurora-moment-video"
                  >
                    <video th:src="${media.url}" class="aurora-moment-video-preview"></video>
                    <div
                      class="aurora-moment-video-overlay"
                      @click="openVideoModal = true"
                    >
                      <i class="i-tabler-play !size-10 text-white"></i>
                    </div>
                    <template x-teleport="body">
                      <div>
                        <div
                          class="fixed inset-0 z-50 bg-gray-900/60 backdrop-blur-sm"
                          aria-hidden="true"
                          x-show="openVideoModal"
                          x-transition:enter="ease-in-out duration-300"
                          x-transition:enter-start="opacity-0"
                          x-transition:enter-end="opacity-100"
                          x-transition:leave="ease-in-out duration-300"
                          x-transition:leave-start="opacity-100"
                          x-transition:leave-end="opacity-0"
                        ></div>
                        <div
                          class="fixed inset-0 z-50 flex items-center justify-center p-4"
                          tabindex="-1"
                          x-show="openVideoModal"
                          x-transition:enter="ease-out duration-200"
                          x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                          x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                          x-transition:leave="ease-in duration-100"
                          x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                          x-transition:leave-end="opacity-0 translate-y-4 sm:scale-95"
                        >
                          <div class="relative w-full max-w-4xl">
                            <button
                              @click="openVideoModal = false"
                              class="absolute -right-12 top-0 flex size-10 items-center justify-center rounded-full bg-white text-gray-600 transition-all hover:bg-gray-100 hover:text-gray-900 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600"
                            >
                              <i class="i-tabler-x !size-5"></i>
                            </button>
                            <video th:src="${media.url}" class="w-full rounded-lg" controls autoplay></video>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
              
              <!-- 操作栏 -->
              <div class="aurora-moment-actions">
                <button
                  type="button"
                  class="aurora-moment-action-btn aurora-moment-like-btn"
                  x-bind:class="{'aurora-moment-liked': upvoted(name)}"
                  @click="handleUpvote(name)"
                >
                  <i x-show="upvoted(name)" class="i-tabler-heart-filled size-4"></i>
                  <i x-show="!upvoted(name)" class="i-tabler-heart size-4"></i>
                  <span
                    class="font-medium"
                    th:attr="data-upvote-moment-name=${moment.metadata.name}"
                    th:text="${moment.stats.upvote}"
                  ></span>
                </button>
                <button
                  type="button"
                  class="aurora-moment-action-btn aurora-moment-comment-btn"
                  :class="{'aurora-moment-comment-active':showComment}"
                  x-on:click="showComment = !showComment"
                >
                  <i class="i-tabler-message-circle size-4"></i>
                  <span class="font-medium" th:text="${moment.stats.approvedComment}"></span>
                </button>
              </div>

              <!-- 评论区域 -->
              <div class="aurora-moment-comments" x-show="showComment" x-cloak>
                <halo:comment group="moment.halo.run" kind="Moment" th:attr="name=${moment.metadata.name}" />
              </div>
            </div>
          </div>
        </li>
      </ul>

      <!-- 分页 -->
      <div class="aurora-moments-pagination">
        <th:block
          th:replace="~{modules/components/pagination :: pagination(context = '/moments/', prevUrl = ${moments.prevUrl}, nextUrl = ${moments.nextUrl}, totalPages = ${moments.totalPages}, page = ${moments.page}, hasPrevious = ${moments.hasPrevious()}, hasNext = ${moments.hasNext()})}"
        />
      </div>
    </div>
  </th:block>
</html>

