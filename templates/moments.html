<!doctype html>
<html
  xmlns:th="https://www.thymeleaf.org"
  th:replace="~{modules/layout :: html(title = |#{page.moments.title} - ${site.title}|, hero = null, content = ~{::content}, head = null, footer = null, sidebar = null, contentClass = null)}"
>
  <th:block th:fragment="content">
    <!-- 使用三栏布局系统 -->
    <th:block th:replace="~{modules/home-layout :: three-column-layout-auto(mainContent = ~{::main-content}, leftContent = null, rightContent = null)}">
      <th:block th:fragment="main-content">

            <!-- 动态列表 -->
            <div class="space-y-4">
              <ul
                role="list"
                class="space-y-4"
                x-data="upvote('moment','moment.halo.run','moments')"
              >
                <li
                  th:each="moment : ${moments.items}"
                  th:attr="x-data=|{name:'${moment.metadata.name}',showComment:false}|"
                  th:with="content=${moment.spec.content}"
                  class="rounded-xl bg-white p-5 shadow-sm transition-all duration-300 hover:shadow-md dark:bg-slate-800"
                >
                  <div class="flex items-start gap-4">
                    <!-- 头像 -->
                    <img
                      th:src="${moment.owner.avatar ?: #theme.assets('/images/default-avatar.svg')}"
                      th:title="${moment.owner.displayName}"
                      th:alt="${moment.owner.displayName}"
                      class="size-10 flex-shrink-0 rounded-full border-2 border-gray-200 dark:border-slate-600"
                    />
                    
                    <!-- 内容区域 -->
                    <div class="flex-1 min-w-0">
                      <!-- 用户信息 -->
                      <div class="mb-2 flex items-center gap-2">
                        <span class="text-sm font-semibold text-gray-900 dark:text-slate-50" th:text="${moment.owner.displayName}"></span>
                        <span class="text-xs text-gray-500 dark:text-slate-400" th:text="${#dates.format(moment.spec.releaseTime,'yyyy-MM-dd HH:mm')}"></span>
                      </div>
                      
                      <!-- 动态内容 -->
                      <div
                        th:utext="${content.html}"
                        class="moment-content prose prose-sm !max-w-full break-words dark:prose-invert prose-pre:p-0 prose-a:text-blue-600 dark:prose-a:text-blue-400 prose-p:my-2 overflow-x-hidden"
                      ></div>
                      
                      <!-- 媒体内容 -->
                      <div
                        th:unless="${#lists.isEmpty(moment.spec.content.medium)}"
                        class="moment-media mt-4 grid w-full max-w-full gap-2"
                        th:classappend="${moment.spec.content.medium.size() == 1 ? 'grid-cols-1' : (moment.spec.content.medium.size() == 2 ? 'grid-cols-2' : 'grid-cols-3')}"
                      >
                        <div class="overflow-hidden rounded-lg w-full max-w-full" th:each="media : ${moment.spec.content.medium}">
                          <img
                            th:if="${#strings.equals(media.type,'PHOTO')}"
                            class="h-full w-full max-w-full transform-gpu cursor-pointer rounded-lg object-cover transition-transform hover:scale-105"
                            th:src="${media.url}"
                            th:srcset="|${thumbnail.gen(media.url, 's')} 400w,
                                        ${thumbnail.gen(media.url, 'm')} 800w,
                                        ${thumbnail.gen(media.url, 'l')} 1200w|"
                            sizes="(max-width: 1200px) 100vw, 1200px"
                          />
                          <div
                            th:if="${#strings.equals(media.type,'VIDEO')}"
                            x-data="{openVideoModal:false}"
                            class="relative aspect-video cursor-pointer overflow-hidden rounded-lg bg-gray-100 dark:bg-slate-700 w-full max-w-full"
                          >
                            <video th:src="${media.url}" class="h-full w-full max-w-full rounded-lg object-cover"></video>
                            <div
                              class="absolute inset-0 flex items-center justify-center bg-black/30 transition-all hover:bg-black/40"
                              @click="openVideoModal = true"
                            >
                              <i class="i-tabler-play !size-10 text-white"></i>
                            </div>
                            <template x-teleport="body">
                              <div>
                                <div
                                  class="fixed inset-0 z-50 bg-gray-900/60 backdrop-blur-sm"
                                  aria-hidden="true"
                                  x-show="openVideoModal"
                                  x-transition:enter="ease-in-out duration-300"
                                  x-transition:enter-start="opacity-0"
                                  x-transition:enter-end="opacity-100"
                                  x-transition:leave="ease-in-out duration-300"
                                  x-transition:leave-start="opacity-100"
                                  x-transition:leave-end="opacity-0"
                                ></div>
                                <div
                                  class="fixed inset-0 z-50 flex items-center justify-center p-4"
                                  tabindex="-1"
                                  x-show="openVideoModal"
                                  x-transition:enter="ease-out duration-200"
                                  x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                                  x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                                  x-transition:leave="ease-in duration-100"
                                  x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                                  x-transition:leave-end="opacity-0 translate-y-4 sm:scale-95"
                                >
                                  <div class="relative w-full max-w-4xl">
                                    <button
                                      @click="openVideoModal = false"
                                      class="absolute -right-12 top-0 flex size-10 items-center justify-center rounded-full bg-white text-gray-600 transition-all hover:bg-gray-100 hover:text-gray-900 dark:bg-slate-700 dark:text-slate-200 dark:hover:bg-slate-600"
                                    >
                                      <i class="i-tabler-x !size-5"></i>
                                    </button>
                                    <video th:src="${media.url}" class="w-full rounded-lg" controls autoplay></video>
                                  </div>
                                </div>
                              </div>
                            </template>
                          </div>
                        </div>
                      </div>
                      
                      <!-- 操作栏 -->
                      <div class="mt-4 flex items-center gap-6 border-t border-gray-100 pt-4 dark:border-slate-700">
                        <button
                          type="button"
                          class="inline-flex items-center gap-1.5 text-sm text-gray-500 transition-all hover:text-red-600 dark:text-slate-400 dark:hover:text-red-500"
                          x-bind:class="{'!text-red-600 dark:!text-red-500': upvoted(name)}"
                          @click="handleUpvote(name)"
                        >
                          <i x-show="upvoted(name)" class="i-tabler-heart-filled size-4"></i>
                          <i x-show="!upvoted(name)" class="i-tabler-heart size-4"></i>
                          <span
                            class="font-medium"
                            th:attr="data-upvote-moment-name=${moment.metadata.name}"
                            th:text="${moment.stats.upvote}"
                          ></span>
                        </button>
                        <button
                          type="button"
                          class="inline-flex items-center gap-1.5 text-sm text-gray-500 transition-all hover:text-blue-600 dark:text-slate-400 dark:hover:text-blue-400"
                          :class="{'!text-blue-600 dark:!text-blue-400':showComment}"
                          x-on:click="showComment = !showComment"
                        >
                          <i class="i-tabler-message-circle size-4"></i>
                          <span class="font-medium" th:text="${moment.stats.approvedComment}"></span>
                        </button>
                      </div>

                      <!-- 评论区域 -->
                      <div class="mt-4 rounded-lg bg-gray-50 p-4 dark:bg-slate-700/50" x-show="showComment" x-cloak>
                        <halo:comment group="moment.halo.run" kind="Moment" th:attr="name=${moment.metadata.name}" />
                      </div>
                    </div>
                  </div>
                </li>
              </ul>
            </div>

            <!-- 分页 -->
            <div class="mt-8">
              <th:block
                th:replace="~{modules/pagination :: pagination(context = '/moments/', prevUrl = ${moments.prevUrl}, nextUrl = ${moments.nextUrl}, totalPages = ${moments.totalPages}, page = ${moments.page}, hasPrevious = ${moments.hasPrevious()}, hasNext = ${moments.hasNext()})}"
              />
            </div>
      </th:block>
    </th:block>
  </th:block>
</html>

