<!doctype html>
<html
  xmlns:th="https://www.thymeleaf.org"
  th:replace="~{modules/layouts/layout :: html(title = |#{page.tags.title} - ${site.title}|, hero = null, content = ~{::content}, head = null, footer = null, sidebar = null, contentClass = null)}"
>
  <th:block th:fragment="content">
    <!-- 使用通用三栏布局 -->
    <th:block th:with="tags = ${tagFinder.listAll()}">
      <th:block th:if="${#lists.isEmpty(tags)}">
        <!-- 空状态 -->
        <th:block th:replace="~{modules/layouts/three-column-layout :: three-column-layout-auto(mainContent = ~{::empty-content}, leftContent = null, rightContent = null)}" />
      </th:block>

      <th:block th:unless="${#lists.isEmpty(tags)}">
        <th:block th:with="selectedTagName=${param.tag != null and not #lists.isEmpty(param.tag) ? param.tag[0] : tags[0].metadata.name}">
          <th:block th:each="tagItem : ${tags}" th:if="${tagItem.metadata.name == selectedTagName}">
            <th:block th:with="tag=${tagItem}">
              <th:block th:replace="~{modules/layouts/three-column-layout :: three-column-layout-auto(mainContent = ~{::main-content}, leftContent = null, rightContent = null)}" />
            </th:block>
          </th:block>
        </th:block>
      </th:block>
    </th:block>
  </th:block>

  <th:block th:fragment="empty-content">
    <div class="flex items-center justify-center py-16">
      <div class="text-center">
        <span class="i-tabler-tags-off text-6xl text-gray-300 dark:text-slate-600"></span>
        <p class="mt-4 text-sm font-light text-gray-600 dark:text-slate-200" th:text="#{page.tags.empty}"></p>
      </div>
    </div>
  </th:block>

  <th:block th:fragment="main-content">
    <th:block th:with="currentPage=${param.page != null and not #lists.isEmpty(param.page) ? #numbers.integer(param.page[0]) : 1},pageSize=${theme.config.post_list.posts_per_page ?: 10},posts = ${postFinder.listByTag(currentPage, pageSize, tag.metadata.name)},base_layout=${theme.config.post_list.post_list_layout ?: 'grid_2'},enable_masonry=${theme.config.post_list.enable_masonry ?: false},list_layout=${(base_layout == 'grid_2' or base_layout == 'grid_3' or base_layout == 'grid_4') and enable_masonry == true ? 'masonry' : base_layout},card_gap=${theme.config.post_list.card_gap ?: 'medium'},card_style=${theme.config.post_list.card_style ?: 'default'},card_animation=${theme.config.post_list.card_animation ?: 'hover_lift'},image_position=${theme.config.post_list.post_image_position ?: 'left'},totalPages=${#numbers.integer(#math.ceil(posts.total / pageSize))},hasPrevious=${currentPage gt 1},hasNext=${currentPage lt totalPages},prevUrl=${hasPrevious ? '|/tags?tag=' + tag.metadata.name + '&page=' + (currentPage - 1)| : null},nextUrl=${hasNext ? '|/tags?tag=' + tag.metadata.name + '&page=' + (currentPage + 1)| : null}">
      <!-- 标签筛选器 -->
      <div class="mb-6 rounded-xl bg-white p-6 shadow-sm transition-all duration-300 hover:shadow-md dark:bg-slate-800">
        <th:block th:replace="~{modules/components/tag-filter}" />
      </div>

      <!-- 使用统一的 post-list 组件 -->
      <th:block th:replace="~{modules/posts/post-list :: post-list(posts = ${posts}, list_layout = ${list_layout}, card_gap = ${card_gap}, card_style = ${card_style}, card_animation = ${card_animation}, image_position = ${image_position}, headerWidget = 'none', isFirstPage = ${currentPage == 1}, showPagination = false, paginationContext = null)}" />
      
      <!-- 手动构建分页（因为 postFinder.listByTag 返回的对象没有分页 URL） -->
      <th:block th:if="${posts.total gt 0 and totalPages gt 1}">
        <div class="mt-8 flex items-center justify-between">
          <a
            th:href="@{${prevUrl}}"
            th:if="${hasPrevious}"
            class="whitespace-no-wrap group inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-600 shadow-sm hover:bg-gray-50 focus:shadow-none focus:outline-none dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 dark:hover:text-white"
          >
            <span class="i-tabler-arrow-left text-lg transition-all group-hover:-translate-x-1"></span>
            <span th:text="#{common.previousPage}"></span>
          </a>
          <span th:unless="${hasPrevious}" class="whitespace-no-wrap inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-400 pointer-events-none opacity-60 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-500">
            <span class="i-tabler-arrow-left text-lg"></span>
            <span th:text="#{common.previousPage}"></span>
          </span>
          
          <select id="pagination-tags" class="bg-transparent text-sm text-gray-900 outline-none dark:text-slate-50">
            <option
              th:each="i : ${#numbers.sequence(1,totalPages)}"
              th:selected="${i == currentPage}"
              th:value="${i}"
              th:text="|${i} / ${totalPages}|"
              class="bg-white text-gray-900 dark:bg-slate-700 dark:text-slate-50"
            ></option>
          </select>
          
          <a
            th:href="@{${nextUrl}}"
            th:if="${hasNext}"
            class="whitespace-no-wrap group inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-600 shadow-sm hover:bg-gray-50 focus:shadow-none focus:outline-none dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 dark:hover:text-white"
          >
            <span th:text="#{common.nextPage}"></span>
            <span class="i-tabler-arrow-right text-lg transition-all group-hover:translate-x-1"></span>
          </a>
          <span th:unless="${hasNext}" class="whitespace-no-wrap inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-400 pointer-events-none opacity-60 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-500">
            <span th:text="#{common.nextPage}"></span>
            <span class="i-tabler-arrow-right text-lg"></span>
          </span>
        </div>
        
        <script th:inline="javascript">
          document.addEventListener("DOMContentLoaded", () => {
            const paginationSelect = document.getElementById("pagination-tags");
            if (!paginationSelect) return;
            
            paginationSelect.addEventListener("change", (event) => {
              const selectedPage = event.target.value;
              const currentUrl = new URL(window.location.href);
              currentUrl.searchParams.set("tag", /*[[${tag.metadata.name}]]*/ "");
              currentUrl.searchParams.set("page", selectedPage);
              window.location.href = currentUrl.toString();
            });
          });
        </script>
      </th:block>
    </th:block>
  </th:block>
</html>
