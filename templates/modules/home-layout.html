<!doctype html>
<html xmlns:th="https://www.thymeleaf.org">
  <!-- 首页顶部大图 -->
  <th:block th:fragment="top-banner">
    <div
      th:if="${theme.config.header.top_banner_height != 'none'}"
      class="aurora-top-banner"
      th:classappend="|${theme.config.header.top_banner_height == 'full' ? 'aurora-top-banner-full' : ''} ${theme.config.header.top_banner_height == 'half' ? 'aurora-top-banner-half' : ''} ${theme.config.header.top_banner_height == 'third' ? 'aurora-top-banner-third' : ''} ${theme.config.header.header_background_type == 'carousel' ? 'aurora-banner-carousel' : ''} ${theme.config.header.header_background_type == 'video' ? 'aurora-banner-video' : ''}|"
      th:with="bgImageStyle=${theme.config.header.header_background_type == 'image' and not #strings.isEmpty(theme.config.header.header_background_image) ? 'background-image: url(' + theme.config.header.header_background_image + ');' : ''},
               bgManualStyle=${theme.config.header.header_background_type == 'manual' and not #strings.isEmpty(theme.config.header.header_background) ? 'background: ' + theme.config.header.header_background + ';' : ''},
               isFullScreen=${theme.config.header.top_banner_height == 'full'},
               useGlobalBg=${theme.config.header.use_banner_as_background == true}"
      th:style="|${bgImageStyle} ${bgManualStyle}|"
      th:attr="data-full-screen=${isFullScreen},data-use-global-bg=${useGlobalBg}"
    >
      <!-- 轮播背景 -->
      <div
        th:if="${theme.config.header.header_background_type == 'carousel' and not #lists.isEmpty(theme.config.header.header_background_carousel)}"
        class="aurora-banner-carousel-container absolute inset-0 z-0"
      >
        <div class="aurora-banner-carousel-slides h-full w-full">
          <div
            th:each="slide, slideStat : ${theme.config.header.header_background_carousel}"
            class="aurora-banner-carousel-slide absolute inset-0 transition-opacity duration-1000 ease-in-out"
            th:classappend="|${slideStat.index == 0 ? 'opacity-100' : 'opacity-0'}|"
            th:style="|background-image: url(${slide.image}); background-size: cover; background-position: center; background-repeat: no-repeat;|"
            th:attr="data-slide-index=${slideStat.index}"
          ></div>
        </div>
      </div>
      <!-- 视频背景 -->
      <video
        th:if="${theme.config.header.header_background_type == 'video' and not #strings.isEmpty(theme.config.header.header_background_video)}"
        class="aurora-banner-video-element absolute inset-0 z-0 h-full w-full object-cover"
        th:src="${theme.config.header.header_background_video}"
        autoplay
        loop
        muted
        playsinline
        preload="auto"
      >      </video>
      <div class="aurora-top-banner-overlay"></div>
      <div class="aurora-top-banner-content" th:if="${(theme.config.header.top_banner_height == 'third' ? (theme.config.header.header_widget_3 != null and theme.config.header.header_widget_3 != 'none') : (theme.config.header.header_widget != null and theme.config.header.header_widget != 'none'))}">
        <th:block th:switch="${theme.config.header.top_banner_height == 'third' ? (theme.config.header.header_widget_3 ?: 'none') : (theme.config.header.header_widget ?: 'none')}">
          <th:block th:case="latest_post" th:with="posts = ${postFinder.list(1,1)}">
            <div class="mx-auto max-w-7xl px-4 py-6 lg:px-6" th:if="${posts.total gt 0}" data-banner-posts="true">
              <th:block th:replace="~{modules/featured-post-card :: featured-post-card(post=${posts.items[0]})}" />
            </div>
          </th:block>
          <th:block th:case="latest_post_grid" th:if="${theme.config.header.top_banner_height != 'third'}" th:with="posts = ${postFinder.list(1,5)}">
            <div
              class="aurora-post-grid-container mx-auto grid max-w-7xl grid-cols-1 gap-2 px-4 py-1 sm:grid-cols-5 sm:py-2 lg:gap-3 lg:px-6 lg:py-2"
              th:if="${posts.total gt 0}"
              data-banner-posts="true"
            >
              <!-- 左侧大卡片 -->
              <div class="col-span-1 sm:col-span-3">
                <th:block
                  th:replace="~{modules/banner-post-card :: banner-post-card-large(post=${posts.items[0]},cover=true,animation=true,border=false,card_style='default',card_animation='hover_lift',image_position='left')}"
                />
              </div>
              <!-- 右侧四个小卡片 -->
              <div class="col-span-1 grid grid-cols-1 gap-2 sm:col-span-2 sm:grid-cols-2 lg:gap-2">
                <th:block th:each="post,postStat : ${posts.items}">
                  <th:block th:if="${postStat.index != 0}">
                    <th:block
                      th:replace="~{modules/banner-post-card :: banner-post-card-small(post=${post},cover=false,animation=true,border=false,card_style='default',card_animation='hover_lift',image_position='left')}"
                    />
                  </th:block>
                </th:block>
              </div>
            </div>
          </th:block>
          <th:block th:case="site_title">
            <div class="mx-auto flex h-full max-w-4xl flex-col items-center justify-center gap-4 px-4 py-6 text-center lg:px-6">
              <h1 class="text-5xl font-bold leading-tight" th:style="|color:${theme.config.header.title_color ?: 'white'}|" th:text="${site.title}"></h1>
              <p
                class="text-lg font-light leading-relaxed max-w-2xl"
                th:style="|color:${theme.config.header.title_color ?: 'rgba(255, 255, 255, 0.9)'}|"
                th:text="${site.subtitle}"
              ></p>
            </div>
          </th:block>
        </th:block>
      </div>
      <!-- 滚动提示按钮（仅全屏时显示，参考 MEGO 主题） -->
      <div
        th:if="${theme.config.header.top_banner_height == 'full'}"
        class="aurora-scroll-indicator"
      >
        <button
          type="button"
          class="aurora-scroll-down-btn"
          aria-label="向下滚动"
        >
          <span class="i-[tabler--chevron-down] text-2xl text-white dark:text-slate-200"></span>
        </button>
      </div>
    </div>
  </th:block>

  <!-- 三栏布局容器（带文章列表）- 首页专用 -->
  <th:block th:fragment="three-column-layout-with-posts(leftContent, rightContent, showCategoryFilter)">
    <th:block th:with="categoryParam=${param.category != null and not #lists.isEmpty(param.category) ? param.category[0] : null},selectedCategory=${categoryParam != null ? categoryFinder.getByName(categoryParam) : null},currentPage=${param.page != null and not #lists.isEmpty(param.page) ? T(java.lang.Integer).valueOf(param.page[0]) : 1},allWidgets=${theme.config.sidebar.sidebar_widgets},headerWidget=${theme.config.header.top_banner_height == 'third' ? (theme.config.header.header_widget_3 ?: 'none') : (theme.config.header.header_widget ?: 'none')},isFirstPage=${currentPage == 1},basePageSize=${theme.config.post_list.posts_per_page ?: 12},pageSize=${isFirstPage and headerWidget == 'latest_post_grid' ? (basePageSize + 5) : basePageSize},filteredPosts=${selectedCategory != null ? postFinder.list({page: currentPage, size: pageSize, categoryName: selectedCategory.metadata.name}) : postFinder.list({page: currentPage, size: pageSize})},list_layout=${theme.config.post_list.post_list_layout ?: 'grid_3'},card_gap=${theme.config.post_list.card_gap ?: 'medium'},card_style=${theme.config.post_list.card_style ?: 'default'},card_animation=${theme.config.post_list.card_animation ?: 'hover_lift'},image_position=${theme.config.post_list.post_image_position ?: 'left'},totalPages=${filteredPosts.totalPages},hasPrevious=${filteredPosts.hasPrevious()},hasNext=${filteredPosts.hasNext()},prevUrl=${hasPrevious ? (selectedCategory != null ? ('/?category=' + selectedCategory.metadata.name + '&page=' + (currentPage - 1)) : ('/?page=' + (currentPage - 1))) : null},nextUrl=${hasNext ? (selectedCategory != null ? ('/?category=' + selectedCategory.metadata.name + '&page=' + (currentPage + 1)) : ('/?page=' + (currentPage + 1))) : null}">
      <!-- 检查左侧是否有启用的、位置匹配的小部件 -->
      <th:block th:with="hasLeftWidgets=${allWidgets != null and not #lists.isEmpty(allWidgets) and allWidgets.?[enabled != false and position == 'left'].size() gt 0}">
        <!-- 检查右侧是否有启用的、位置匹配的小部件 -->
        <th:block th:with="hasRightWidgets=${allWidgets != null and not #lists.isEmpty(allWidgets) and allWidgets.?[enabled != false and position == 'right'].size() gt 0}">
          <th:block th:with="hasLeftContent=${leftContent != null},hasRightContent=${rightContent != null},showLeft=${hasLeftContent or hasLeftWidgets},showRight=${hasRightContent or hasRightWidgets}">
            <!-- aurora-body 容器：控制整体宽度和居中 -->
            <div class="aurora-body">
              <!-- 内部 grid 布局：左侧栏（百分比）、主内容（1fr）、右侧栏（百分比） -->
              <div class="aurora-three-column">
            <!-- 第一列（左侧栏） -->
            <aside
              th:if="${showLeft}"
              class="aurora-left-sidebar"
              th:classappend="|${theme.config.sidebar.sticky_behavior == 'sticky_to_header' ? 'aurora-sidebar-sticky-header' : ''} ${theme.config.sidebar.sticky_behavior == 'sticky_independent' ? 'aurora-sidebar-sticky-independent' : ''}|"
            >
              <th:block th:if="${leftContent != null}">
                <th:block th:replace="${leftContent}" />
              </th:block>
              <th:block th:if="${leftContent == null and hasLeftWidgets}">
                <th:block th:replace="~{modules/configured-sidebar :: configured-sidebar(widgets = ${allWidgets}, position = 'left')}" />
              </th:block>
            </aside>

        <!-- 第二列（主内容区 - 必需） -->
        <main class="aurora-main-content">
          <div class="aurora-main-content-inner">
            <!-- 分类筛选器（仅在首页且启用时显示，贴紧文章列表顶部） -->
            <div th:if="${showCategoryFilter == true}" class="mb-[1px]">
              <th:block th:replace="~{modules/category-filter}" />
            </div>
            
            <!-- 文章列表容器（独立组件，通过 AJAX 动态加载） -->
            <div id="post-list-container">
              <th:block th:replace="~{modules/post-list :: post-list(posts = ${filteredPosts}, list_layout = ${list_layout}, card_gap = ${card_gap}, card_style = ${card_style}, card_animation = ${card_animation}, image_position = ${image_position}, headerWidget = ${headerWidget}, isFirstPage = ${isFirstPage}, showPagination = false, paginationContext = null)}" />
              
              <!-- 手动构建分页 -->
              <th:block th:if="${filteredPosts.total gt 0 and totalPages gt 1}">
                <div class="mt-8 flex items-center justify-between">
                  <a
                    th:href="@{${prevUrl}}"
                    th:if="${hasPrevious}"
                    class="whitespace-no-wrap group inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-600 shadow-sm hover:bg-gray-50 focus:shadow-none focus:outline-none dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 dark:hover:text-white"
                  >
                    <span class="i-tabler-arrow-left text-lg transition-all group-hover:-translate-x-1"></span>
                    <span th:text="#{common.previousPage}"></span>
                  </a>
                  <span th:unless="${hasPrevious}" class="whitespace-no-wrap inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-400 pointer-events-none opacity-60 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-500">
                    <span class="i-tabler-arrow-left text-lg"></span>
                    <span th:text="#{common.previousPage}"></span>
                  </span>
                  
                  <select id="pagination-home" class="bg-transparent text-sm text-gray-900 outline-none dark:text-slate-50">
                    <option
                      th:each="i : ${#numbers.sequence(1,totalPages)}"
                      th:selected="${i == currentPage}"
                      th:value="${i}"
                      th:text="|${i} / ${totalPages}|"
                      class="bg-white text-gray-900 dark:bg-slate-700 dark:text-slate-50"
                    ></option>
                  </select>
                  
                  <a
                    th:href="@{${nextUrl}}"
                    th:if="${hasNext}"
                    class="whitespace-no-wrap group inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-600 shadow-sm hover:bg-gray-50 focus:shadow-none focus:outline-none dark:border-slate-600 dark:bg-slate-700 dark:text-slate-100 dark:hover:bg-slate-600 dark:hover:text-white"
                  >
                    <span th:text="#{common.nextPage}"></span>
                    <span class="i-tabler-arrow-right text-lg transition-all group-hover:translate-x-1"></span>
                  </a>
                  <span th:unless="${hasNext}" class="whitespace-no-wrap inline-flex items-center justify-center gap-1 rounded-md border border-gray-200 bg-white px-4 py-1 text-sm font-medium leading-6 text-gray-400 pointer-events-none opacity-60 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-500">
                    <span th:text="#{common.nextPage}"></span>
                    <span class="i-tabler-arrow-right text-lg"></span>
                  </span>
                </div>
                
                <script th:inline="javascript">
                  document.addEventListener("DOMContentLoaded", () => {
                    const paginationSelect = document.getElementById("pagination-home");
                    if (!paginationSelect) return;
                    
                    paginationSelect.addEventListener("change", (event) => {
                      const selectedPage = event.target.value;
                      const currentUrl = new URL(window.location.href);
                      const categoryParam = /*[[${categoryParam}]]*/ null;
                      if (categoryParam) {
                        currentUrl.searchParams.set("category", categoryParam);
                      }
                      currentUrl.searchParams.set("page", selectedPage);
                      window.location.href = currentUrl.toString();
                    });
                  });
                </script>
              </th:block>
            </div>
          </div>
        </main>

            <!-- 第三列（右侧栏） -->
            <aside
              th:if="${showRight}"
              class="aurora-right-sidebar"
              th:classappend="|${theme.config.sidebar.sticky_behavior == 'sticky_to_header' ? 'aurora-sidebar-sticky-header' : ''} ${theme.config.sidebar.sticky_behavior == 'sticky_independent' ? 'aurora-sidebar-sticky-independent' : ''}|"
            >
              <th:block th:if="${rightContent != null}">
                <th:block th:replace="${rightContent}" />
              </th:block>
              <th:block th:if="${rightContent == null and hasRightWidgets}">
                <th:block th:replace="~{modules/configured-sidebar :: configured-sidebar(widgets = ${allWidgets}, position = 'right')}" />
              </th:block>
            </aside>
              </div>
            </div>
          </th:block>
        </th:block>
      </th:block>
    </th:block>
  </th:block>

  <!-- 三栏布局容器（通用，自动检测小部件）- 委托给通用组件 -->
  <th:block th:fragment="three-column-layout-auto(mainContent, leftContent, rightContent)">
    <th:block th:replace="~{modules/components/three-column-layout :: three-column-layout-auto(mainContent = ${mainContent}, leftContent = ${leftContent}, rightContent = ${rightContent})}" />
  </th:block>

  <!-- 三栏布局容器（通用，保留兼容性） -->
  <th:block th:fragment="three-column-layout(leftContent, mainContent, rightContent)">
    <div
      class="aurora-three-column"
      th:with="columnLayout='main-right',showLeft=false,showRight=true"
      th:classappend="|${columnLayout == 'main-only' ? 'layout-main-only' : ''} ${columnLayout == 'left-main' ? 'layout-left-main' : ''} ${columnLayout == 'main-right' ? 'layout-main-right' : ''} ${columnLayout == 'three-column' ? 'layout-three-column' : ''}|"
    >
      <!-- 左侧栏 -->
      <aside
        th:if="${(columnLayout == 'left-main' or columnLayout == 'three-column') and showLeft}"
        class="aurora-left-sidebar"
      >
        <th:block th:if="${leftContent != null}">
          <th:block th:replace="${leftContent}" />
        </th:block>
        <th:block th:if="${leftContent == null}">
          <th:block th:replace="~{modules/sidebar :: sidebar(prepend = null)}" />
        </th:block>
      </aside>

      <!-- 主内容区 -->
      <main class="aurora-main-content">
        <div class="aurora-main-content-inner">
          <th:block th:replace="${mainContent}" />
        </div>
      </main>

      <!-- 右侧栏 -->
      <aside
        th:if="${(columnLayout == 'main-right' or columnLayout == 'three-column') and showRight}"
        class="aurora-right-sidebar"
      >
        <th:block th:if="${rightContent != null}">
          <th:block th:replace="${rightContent}" />
        </th:block>
        <th:block th:if="${rightContent == null}">
          <th:block th:replace="~{modules/sidebar :: sidebar(prepend = null)}" />
        </th:block>
      </aside>
    </div>
  </th:block>
</html>
